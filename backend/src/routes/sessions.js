const express = require('express');\nconst router = express.Router();\nconst sessionManager = require('../services/sessionManager');\nconst aiEvaluationEngine = require('../ai-engines/ai-evaluation-engine');\n\n// Get session by ID\nrouter.get('/:sessionId', async (req, res) => {\n  try {\n    const session = await sessionManager.getSession(req.params.sessionId);\n    if (!session) {\n      return res.status(404).json({ error: 'Session not found' });\n    }\n    res.json({ success: true, session });\n  } catch (error) {\n    console.error('Get session error:', error);\n    res.status(500).json({ error: 'Failed to get session' });\n  }\n});\n\n// Save answer for a question\nrouter.post('/:sessionId/answer', async (req, res) => {\n  try {\n    const { sessionId } = req.params;\n    const { questionIndex, answer, timeSpent, isAutoSubmitted } = req.body;\n    \n    const answerData = {\n      text: answer?.text || '',\n      timeSpent: timeSpent || 0,\n      isAutoSubmitted: isAutoSubmitted || false,\n      confidence: answer?.confidence || null,\n      voiceMetrics: answer?.voiceMetrics || null\n    };\n    \n    const updatedSession = await sessionManager.saveAnswer(sessionId, questionIndex, answerData);\n    \n    res.json({ \n      success: true, \n      session: updatedSession,\n      isComplete: updatedSession.status === 'completed'\n    });\n  } catch (error) {\n    console.error('Save answer error:', error);\n    res.status(500).json({ error: 'Failed to save answer' });\n  }\n});\n\n// Pause session\nrouter.post('/:sessionId/pause', async (req, res) => {\n  try {\n    const session = await sessionManager.pauseSession(req.params.sessionId);\n    res.json({ success: true, session });\n  } catch (error) {\n    console.error('Pause session error:', error);\n    res.status(500).json({ error: 'Failed to pause session' });\n  }\n});\n\n// Resume session\nrouter.post('/:sessionId/resume', async (req, res) => {\n  try {\n    const session = await sessionManager.resumeSession(req.params.sessionId);\n    res.json({ success: true, session });\n  } catch (error) {\n    console.error('Resume session error:', error);\n    res.status(500).json({ error: 'Failed to resume session' });\n  }\n});\n\n// Complete session and get AI evaluation\nrouter.post('/:sessionId/complete', async (req, res) => {\n  try {\n    const session = await sessionManager.getSession(req.params.sessionId);\n    if (!session) {\n      return res.status(404).json({ error: 'Session not found' });\n    }\n    \n    console.log('ðŸ¤– Starting AI evaluation for session:', session.id);\n    const aiEvaluation = await aiEvaluationEngine.evaluateSession(session);\n    \n    const completedSession = await sessionManager.completeSession(session.id, aiEvaluation);\n    \n    res.json({ \n      success: true, \n      session: completedSession,\n      evaluation: aiEvaluation\n    });\n  } catch (error) {\n    console.error('Complete session error:', error);\n    res.status(500).json({ error: 'Failed to complete session' });\n  }\n});\n\n// Get all sessions (with optional candidate filter)\nrouter.get('/', async (req, res) => {\n  try {\n    const { candidateId } = req.query;\n    const sessions = await sessionManager.getAllSessions(candidateId);\n    \n    // Get stats for each session\n    const sessionsWithStats = await Promise.all(\n      sessions.map(async (session) => {\n        const stats = await sessionManager.getSessionStats(session.id);\n        return { ...session, stats };\n      })\n    );\n    \n    res.json({ success: true, sessions: sessionsWithStats });\n  } catch (error) {\n    console.error('Get sessions error:', error);\n    res.status(500).json({ error: 'Failed to get sessions' });\n  }\n});\n\n// Get session statistics\nrouter.get('/:sessionId/stats', async (req, res) => {\n  try {\n    const stats = await sessionManager.getSessionStats(req.params.sessionId);\n    if (!stats) {\n      return res.status(404).json({ error: 'Session not found' });\n    }\n    res.json({ success: true, stats });\n  } catch (error) {\n    console.error('Get session stats error:', error);\n    res.status(500).json({ error: 'Failed to get session stats' });\n  }\n});\n\n// Delete session\nrouter.delete('/:sessionId', async (req, res) => {\n  try {\n    const deleted = await sessionManager.deleteSession(req.params.sessionId);\n    if (!deleted) {\n      return res.status(404).json({ error: 'Session not found' });\n    }\n    res.json({ success: true, message: 'Session deleted' });\n  } catch (error) {\n    console.error('Delete session error:', error);\n    res.status(500).json({ error: 'Failed to delete session' });\n  }\n});\n\n// Generate follow-up question\nrouter.post('/:sessionId/followup', async (req, res) => {\n  try {\n    const { questionIndex, answer } = req.body;\n    const session = await sessionManager.getSession(req.params.sessionId);\n    \n    if (!session) {\n      return res.status(404).json({ error: 'Session not found' });\n    }\n    \n    const question = session.questions[questionIndex];\n    if (!question) {\n      return res.status(400).json({ error: 'Invalid question index' });\n    }\n    \n    const followUpQuestion = await aiEvaluationEngine.generateFollowUpQuestion(\n      question.text,\n      answer,\n      session.candidate?.technicalSkills\n    );\n    \n    if (followUpQuestion) {\n      res.json({ \n        success: true, \n        followUp: {\n          followUpQuestion,\n          reason: 'Based on your previous answer'\n        }\n      });\n    } else {\n      res.json({ success: true, followUp: null });\n    }\n  } catch (error) {\n    console.error('Generate follow-up error:', error);\n    res.status(500).json({ error: 'Failed to generate follow-up question' });\n  }\n});\n\n// Cleanup old sessions\nrouter.post('/cleanup', async (req, res) => {\n  try {\n    const { daysOld = 30 } = req.body;\n    const deletedCount = await sessionManager.cleanupOldSessions(daysOld);\n    res.json({ \n      success: true, \n      message: `Cleaned up ${deletedCount} old sessions` \n    });\n  } catch (error) {\n    console.error('Cleanup sessions error:', error);\n    res.status(500).json({ error: 'Failed to cleanup sessions' });\n  }\n});\n\nmodule.exports = router;\n