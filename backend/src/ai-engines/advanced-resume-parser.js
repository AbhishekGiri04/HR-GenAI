const mammoth = require('mammoth');\nconst fs = require('fs');\nconst path = require('path');\n\nclass AdvancedResumeParser {\n  constructor() {\n    this.skillKeywords = [\n      'javascript', 'python', 'java', 'react', 'node', 'html', 'css', 'sql', 'mongodb', 'express',\n      'angular', 'vue', 'php', 'c++', 'c#', 'ruby', 'go', 'rust', 'swift', 'kotlin', 'flutter',\n      'django', 'flask', 'spring', 'laravel', 'docker', 'kubernetes', 'aws', 'azure', 'git',\n      'github', 'mysql', 'postgresql', 'redis', 'elasticsearch', 'typescript', 'nextjs', 'vuejs',\n      'reactjs', 'nodejs', 'bootstrap', 'tailwind', 'sass', 'webpack', 'babel', 'jest', 'cypress'\n    ];\n  }\n\n  extractEmail(text) {\n    const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/g;\n    const matches = text.match(emailRegex);\n    return matches ? matches[0] : '';\n  }\n\n  extractPhone(text) {\n    const phonePatterns = [\n      /\\+?\\d{1,3}[\\s-]?\\(?\\d{3}\\)?[\\s-]?\\d{3}[\\s-]?\\d{4}/g,\n      /\\+?\\d{10,}/g,\n      /\\(?\\d{3}\\)?[\\s-]?\\d{3}[\\s-]?\\d{4}/g\n    ];\n    \n    for (let pattern of phonePatterns) {\n      const matches = text.match(pattern);\n      if (matches) return matches[0];\n    }\n    return '';\n  }\n\n  extractName(text) {\n    const lines = text.split(/\\r?\\n/).map(l => l.trim()).filter(Boolean);\n    if (!lines.length) return '';\n    \n    const skipWords = ['resume', 'cv', 'curriculum', 'vitae', 'profile', 'professional', 'summary'];\n    \n    for (let line of lines.slice(0, 5)) {\n      const cleanLine = line.trim();\n      \n      if (skipWords.some(word => cleanLine.toLowerCase().includes(word))) continue;\n      if (cleanLine.includes('@') || /\\d{10}/.test(cleanLine)) continue;\n      \n      if (/^[A-Z][a-zA-Z]+(\\s+[A-Z][a-zA-Z]+){1,3}$/.test(cleanLine)) {\n        return cleanLine;\n      }\n      \n      if (cleanLine.length > 3 && cleanLine.length < 50 && /^[A-Za-z\\s\\.]+$/.test(cleanLine)) {\n        return cleanLine;\n      }\n    }\n    \n    return lines[0] || '';\n  }\n\n  extractLocation(text) {\n    const locationPatterns = [\n      /([A-Za-z\\s]+\\s*\\(\\d{6}\\)[^\\n]{0,30})/,\n      /address[:\\s]+([^\\n]{5,50})/i,\n      /location[:\\s]+([^\\n]{5,50})/i,\n      /([A-Za-z\\s]+,\\s*[A-Za-z\\s]+,?\\s*\\d{5,6})/,\n      /(New Delhi|Mumbai|Bangalore|Chennai|Hyderabad|Pune|Kolkata|Ahmedabad|Jaipur|Lucknow|Kanpur|Nagpur|Indore|Haridwar)[^\\n]{0,50}/i\n    ];\n    \n    for (let pattern of locationPatterns) {\n      const match = text.match(pattern);\n      if (match) {\n        const location = match[1] || match[0];\n        if (!location.toLowerCase().includes('professional') && \n            !location.toLowerCase().includes('summary')) {\n          return location.trim();\n        }\n      }\n    }\n    return '';\n  }\n\n  extractSkills(text) {\n    const lowerText = text.toLowerCase();\n    const foundSkills = this.skillKeywords.filter(skill => \n      lowerText.includes(skill.toLowerCase())\n    );\n    \n    const skillsSection = this.extractSection(text, ['skills', 'technical skills', 'technologies']);\n    if (skillsSection) {\n      const additionalSkills = this.skillKeywords.filter(skill => \n        skillsSection.toLowerCase().includes(skill.toLowerCase())\n      );\n      foundSkills.push(...additionalSkills);\n    }\n    \n    return [...new Set(foundSkills)];\n  }\n\n  extractSection(text, sectionNames) {\n    for (let sectionName of sectionNames) {\n      const regex = new RegExp(`${sectionName}[:\\s]*([\\s\\S]*?)(?=\\n[A-Z][A-Z\\s]+:|$)`, 'i');\n      const match = text.match(regex);\n      if (match) return match[1].trim();\n    }\n    return '';\n  }\n\n  async parseFile(filePath, mimetype) {\n    let text = '';\n    \n    try {\n      if (mimetype === 'application/pdf') {\n        const pdf = require('pdf-parse');\n        const dataBuffer = fs.readFileSync(filePath);\n        const pdfData = await pdf(dataBuffer, {\n          normalizeWhitespace: false,\n          disableCombineTextItems: false\n        });\n        text = pdfData.text;\n      } else if (mimetype.includes('word') || mimetype.includes('document')) {\n        const result = await mammoth.extractRawText({ path: filePath });\n        text = result.value;\n      } else {\n        text = fs.readFileSync(filePath, 'utf-8');\n      }\n    } catch (error) {\n      throw new Error(`Failed to parse file: ${error.message}`);\n    }\n    \n    if (!text || text.trim().length < 20) {\n      throw new Error('File content is too short or empty');\n    }\n    \n    const name = this.extractName(text);\n    const email = this.extractEmail(text);\n    const phone = this.extractPhone(text);\n    const location = this.extractLocation(text);\n    const technicalSkills = this.extractSkills(text);\n    \n    const overallScore = Math.min(technicalSkills.length * 8 + 20, 95);\n    const learningVelocity = Math.min(Math.floor(technicalSkills.length / 2) + 3, 9);\n    \n    return {\n      personalInfo: {\n        name: name || 'Candidate',\n        email: email || 'candidate@example.com',\n        phone: phone || '',\n        location: location || ''\n      },\n      technicalSkills,\n      softSkills: ['Communication', 'Problem Solving', 'Teamwork', 'Leadership'],\n      experience: [],\n      education: [],\n      projects: [],\n      certifications: [],\n      languages: ['English'],\n      overallScore,\n      learningVelocity,\n      rawText: text.substring(0, 1000)\n    };\n  }\n}\n\nmodule.exports = new AdvancedResumeParser();\n